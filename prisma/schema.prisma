generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Settings {
  id                      Int     @id @default(autoincrement())
  currency                String  @default("CLP")
  vatRate                 Float   @default(0.19)
  defaultPaymentTermsDays Int     @default(30)
  yellowThresholdDays     Int     @default(7)
  isSoloMode              Boolean @default(false)
}

model Company {
  id             String        @id @default(uuid())
  organizationId String?       @db.Uuid
  name           String
  taxId          String?
  address        String?
  phone          String?
  email          String?
  contactName    String?
  projects       Project[]
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

model Project {
  id             String        @id
  organizationId String?       @db.Uuid
  companyId      String?
  name           String
  responsible    String
  status         ProjectStatus
  stage          ProjectStage
  progress       Int           @default(0)
  startDate      DateTime
  plannedEndDate DateTime
  nextAction     String?
  budgetNet      Float         @default(0)
  marginPct      Float         @default(0.30)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  acceptedAt     DateTime?
  blockingReason String?
  nextActionDate DateTime?     @db.Timestamptz(6)
  currency       String?       @default("CLP")
  paymentMethod  String        @default("FIFTY_FIFTY") // CASH, FIFTY_FIFTY, 30_DAYS
  scopeDetails   String?
  clientId       String?       @db.Uuid
  quoteSentDate  DateTime?     @db.Timestamptz(6)
  AuditLog       AuditLog[]
  costEntries    CostEntry[]
  Interaction    Interaction[]
  invoices       Invoice[]
  Client         Client?       @relation(fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  company        Company?      @relation(fields: [companyId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id])
  tasks          Task[]
  logs           ProjectLog[]
  quoteItems     QuoteItem[]
  quotes         Quote[]
  saleNote       SaleNote?
  closeReason    CloseReason?
}

model SaleNote {
  id             String        @id @default(uuid())
  projectId      String        @unique
  organizationId String?       @db.Uuid
  correlative    Int           @default(autoincrement())
  status         String        @default("ISSUED") // ISSUED, ANNULLED
  generatedAt    DateTime      @default(now())
  pdfUrl         String?
  project        Project       @relation(fields: [projectId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

model QuoteItem {
  id             String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  projectId      String
  quoteId        String?
  organizationId String?       @db.Uuid
  sku            String?
  detail         String
  quantity       Float         @default(1)
  unit           String        @default("UN")
  priceNet       Float         @default(0)
  costNet        Float         @default(0)
  isSelected     Boolean       @default(true)
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  quote          Quote?        @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

model CostEntry {
  id             String        @id @default(uuid())
  projectId      String
  organizationId String?       @db.Uuid
  date           DateTime
  category       CostCategory
  description    String
  amountNet      Float
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

model Invoice {
  id                  String        @id @default(uuid())
  projectId           String
  organizationId      String?       @db.Uuid
  sent                Boolean       @default(false)
  sentDate            DateTime?
  paymentTermsDays    Int?
  dueDate             DateTime?
  amountInvoicedGross Float         @default(0)
  amountPaidGross     Float         @default(0)
  updatedAt           DateTime      @updatedAt
  project             Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization        Organization? @relation(fields: [organizationId], references: [id])
}

model ProjectLog {
  id             String        @id @default(uuid())
  projectId      String
  organizationId String?       @db.Uuid
  content        String
  type           String        @default("INFO")
  createdAt      DateTime      @default(now())
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

model Product {
  id             String        @id @default(uuid())
  organizationId String?       @db.Uuid
  sku            String        @unique
  name           String
  description    String?
  unit           String        @default("UN")
  priceNet       Float         @default(0)
  costNet        Float         @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

model AuditLog {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId      String
  organizationId String?       @db.Uuid
  action         String
  details        String?
  userName       String?
  createdAt      DateTime?     @default(now()) @db.Timestamptz(6)
  userId         String?       @db.Uuid
  Project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Profile        Profile?      @relation(fields: [userId], references: [id], onUpdate: NoAction)
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Client {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?       @db.Uuid
  name           String
  email          String?
  phone          String?
  address        String?
  taxId          String?
  contactName    String?
  createdAt      DateTime      @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  updatedAt      DateTime      @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  status         ClientStatus  @default(PROSPECT)
  Contact        Contact[]
  Interaction    Interaction[]
  Project        Project[]
  opportunities  Opportunity[]
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Contact {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId  String   @db.Uuid
  name      String
  email     String?
  phone     String?
  role      String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @db.Timestamptz(6)
  Client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Interaction {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId       String          @db.Uuid
  projectId      String?
  organizationId String?         @db.Uuid
  type           InteractionType
  date           DateTime        @default(now()) @db.Timestamptz(6)
  notes          String
  createdAt      DateTime        @default(now()) @db.Timestamptz(6)
  Client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Project        Project?        @relation(fields: [projectId], references: [id], onUpdate: NoAction)
  organization   Organization?   @relation(fields: [organizationId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Profile {
  id             String        @id(map: "profile_pkey") @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?       @db.Uuid
  name           String
  email          String        @unique(map: "profile_email_key")
  role           String        @default("USER")
  avatarUrl      String?
  createdAt      DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime      @default(now()) @db.Timestamptz(6)
  AuditLog       AuditLog[]
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

model Organization {
  id                 String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  rut                String?
  logoUrl            String?
  settings           Json?                @default("{}")
  createdAt          DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime             @default(now()) @db.Timestamptz(6)
  status             OrganizationStatus?  @default(ACTIVE)
  plan               OrganizationPlan?    @default(FREE)
  profiles           Profile[]
  projects           Project[]
  tasks              Task[]
  alerts             SentinelAlert[]
  stats              OrganizationStats?
  subscription       Subscription?
  Opportunity        Opportunity[]
  Client             Client[]
  Company            Company[]
  Invoice            Invoice[]
  Product            Product[]
  Interaction        Interaction[]
  AuditLog           AuditLog[]
  ProjectLog         ProjectLog[]
  QuoteItem          QuoteItem[]
  CostEntry          CostEntry[]
  SaleNote           SaleNote[]
  UserInvitation     UserInvitation[]
  OrganizationMember OrganizationMember[]
  mode               OrganizationMode     @default(SOLO)
}

model StripeEvent {
  id        String   @id // This is the Stripe Event ID
  type      String
  processed Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Subscription {
  id                     String             @id @default(uuid())
  organizationId         String             @unique @db.Uuid
  status                 SubscriptionStatus @default(TRIALING)
  planCode               String             @default("FREE")
  trialEndsAt            DateTime?
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  cancelAtPeriodEnd      Boolean            @default(false)
  seatLimit              Int                @default(1)
  provider               String? // e.g., 'stripe'
  providerCustomerId     String?
  providerSubscriptionId String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  organization           Organization       @relation(fields: [organizationId], references: [id])
}

model OrganizationMember {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?          @db.Uuid
  userId         String?          @db.Uuid
  role           String?          @default("admin")
  status         MembershipStatus @default(ACTIVE)
  createdAt      DateTime         @default(now()) @db.Timestamptz(6)
  organization   Organization?    @relation(fields: [organizationId], references: [id])
}

model UserInvitation {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String
  role           String       @default("USER")
  organizationId String       @db.Uuid
  token          String
  expiresAt      DateTime     @db.Timestamptz(6)
  createdAt      DateTime     @default(now()) @db.Timestamptz(6)
  acceptedAt     DateTime?    @db.Timestamptz(6)
  organization   Organization @relation(fields: [organizationId], references: [id])
}

enum OrganizationStatus {
  PENDING
  ACTIVE
  INACTIVE
}

enum OrganizationPlan {
  FREE
  PRO
  ENTERPRISE
  INVENTORY_ONLY
}

enum OrganizationMode {
  SOLO
  TEAM
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAUSED
  PAST_DUE
  CANCELED
}

enum MembershipStatus {
  PENDING
  ACTIVE
  INACTIVE
}

enum ProjectStatus {
  EN_CURSO
  EN_ESPERA
  BLOQUEADO
  CERRADO
  CANCELADO
}

enum ProjectStage {
  LEVANTAMIENTO
  DISENO
  DESARROLLO
  QA             @map("QA")
  IMPLEMENTACION
  SOPORTE
}

enum CostCategory {
  SERVICIOS
  HARDWARE
  SOFTWARE
  LOGISTICA
  OTROS
}

enum ClientStatus {
  LEAD
  PROSPECT
  CLIENT
  CHURNED
}

enum InteractionType {
  CALL
  EMAIL
  MEETING
  NOTE
}

model Task {
  id             String        @id @default(uuid())
  projectId      String
  organizationId String?       @db.Uuid
  title          String
  description    String?
  status         TaskStatus    @default(PENDING)
  dueDate        DateTime?
  priority       Int           @default(0) // 0: Normal, 1: High
  type           TaskType      @default(MANUAL)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])
}

enum TaskType {
  MANUAL
  SENTINEL
}

enum TaskStatus {
  PENDING
  COMPLETED
}

model Quote {
  id        String      @id @default(uuid())
  projectId String
  version   Int         @default(1)
  status    QuoteStatus @default(DRAFT)
  totalNet  Float       @default(0)
  totalTax  Float       @default(0)
  frozenAt  DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items     QuoteItem[]
}

model Opportunity {
  id                  String        @id @default(uuid())
  title               String
  description         String?
  value               Float?
  probability         Int?          @default(0)
  stage               String        @default("QUALIFIED")
  expectedCloseDate   DateTime?
  lastInteractionDate DateTime?     @db.Timestamptz(6)
  nextInteractionDate DateTime?     @db.Timestamptz(6)
  clientId            String?       @db.Uuid
  organizationId      String?       @db.Uuid
  closeReason         CloseReason?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  client              Client?       @relation(fields: [clientId], references: [id])
  organization        Organization? @relation(fields: [organizationId], references: [id])
}

model SentinelAlert {
  id             String           @id @default(uuid())
  organizationId String           @db.Uuid
  type           SentinelType
  severity       SentinelSeverity
  title          String
  message        String
  status         AlertStatus      @default(OPEN)
  metadata       Json? // Para guardar links al proyecto, stock id, etc.
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id])
}

model OrganizationStats {
  id               String       @id @default(uuid())
  organizationId   String       @unique @db.Uuid
  wau              Int          @default(0)
  mau              Int          @default(0)
  daysToFirstQuote Int?
  crmCount         Int          @default(0)
  quotesCount      Int          @default(0)
  projectsCount    Int          @default(0)
  inventoryCount   Int          @default(0)
  lastActivityAt    DateTime     @default(now())
  lastSentinelRunAt DateTime?
  healthScore      Int          @default(100)
  organization     Organization @relation(fields: [organizationId], references: [id])
}

enum SentinelType {
  STOCK_CRITICAL
  BUDGET_OVERFLOW
  INVOICE_OVERDUE
  STALE_PROJECT
  LOW_MARGIN
  QUOTE_FOLLOWUP
}

enum SentinelSeverity {
  S0
  S1
  S2
  S3
}

enum AlertStatus {
  OPEN
  ACK
  RESOLVED
}

enum CloseReason {
  PRICE
  COMPETITION
  DELAY
  SCOPE
  DISCARDED
  OTHER
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REVISED
  REJECTED
}
