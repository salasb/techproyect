generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  schemas  = ["public"]
}

model Settings {
  id                      Int     @id @default(autoincrement())
  currency                String  @default("CLP")
  vatRate                 Float   @default(0.19)
  defaultPaymentTermsDays Int     @default(30)
  yellowThresholdDays     Int     @default(7)
  isSoloMode              Boolean @default(false)

  @@schema("public")
}

model Company {
  id             String        @id @default(uuid())
  organizationId String?       @db.Uuid
  name           String
  taxId          String?
  address        String?
  phone          String?
  email          String?
  contactName    String?
  projects       Project[]
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model Project {
  id             String        @id
  organizationId String?       @db.Uuid
  companyId      String?
  name           String
  responsible    String
  status         ProjectStatus
  stage          ProjectStage
  progress       Int           @default(0)
  startDate      DateTime
  plannedEndDate DateTime
  nextAction     String?
  budgetNet      Float         @default(0)
  marginPct      Float         @default(0.30)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  acceptedAt     DateTime?
  blockingReason String?
  nextActionDate DateTime?     @db.Timestamptz(6)
  currency       String?       @default("CLP")
  paymentMethod  String        @default("FIFTY_FIFTY") // CASH, FIFTY_FIFTY, 30_DAYS
  scopeDetails   String?
  clientId       String?       @db.Uuid
  quoteSentDate  DateTime?     @db.Timestamptz(6)
  AuditLog       AuditLog[]
  costEntries    CostEntry[]
  Interaction    Interaction[]
  invoices       Invoice[]
  Client         Client?       @relation(fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  company        Company?      @relation(fields: [companyId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id])
  tasks          Task[]
  logs           ProjectLog[]
  quoteItems     QuoteItem[]
  quotes         Quote[]
  saleNote       SaleNote?
  closeReason    CloseReason?
  inventoryMovements InventoryMovement[]

  @@schema("public")
}

model SaleNote {
  id             String        @id @default(uuid())
  projectId      String        @unique
  organizationId String?       @db.Uuid
  correlative    Int           @default(autoincrement())
  status         String        @default("ISSUED") // ISSUED, ANNULLED
  generatedAt    DateTime      @default(now())
  pdfUrl         String?
  project        Project       @relation(fields: [projectId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model QuoteItem {
  id             String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  projectId      String
  quoteId        String?
  organizationId String?       @db.Uuid
  sku            String?
  detail         String
  quantity       Float         @default(1)
  unit           String        @default("UN")
  priceNet       Float         @default(0)
  costNet        Float         @default(0)
  isSelected     Boolean       @default(true)
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  quote          Quote?        @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model CostEntry {
  id             String        @id @default(uuid())
  projectId      String
  organizationId String?       @db.Uuid
  date           DateTime
  category       CostCategory
  description    String
  amountNet      Float
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model Invoice {
  id                  String        @id @default(uuid())
  projectId           String
  organizationId      String?       @db.Uuid
  sent                Boolean       @default(false)
  sentDate            DateTime?
  paymentTermsDays    Int?
  dueDate             DateTime?
  amountInvoicedGross Float         @default(0)
  amountPaidGross     Float         @default(0)
  updatedAt           DateTime      @updatedAt
  project             Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization        Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model ProjectLog {
  id             String        @id @default(uuid())
  projectId      String
  organizationId String?       @db.Uuid
  content        String
  type           String        @default("INFO")
  createdAt      DateTime      @default(now())
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model Product {
  id             String        @id @default(uuid())
  organizationId String?       @db.Uuid
  sku            String        @unique
  name           String
  description    String?
  unit           String        @default("UN")
  priceNet       Float         @default(0)
  costNet        Float         @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
  stockEntries   ProductStock[]

  @@schema("public")
}

model InventoryMovement {
  id             String        @id @default(uuid())
  projectId      String
  organizationId String?       @db.Uuid
  sku            String
  quantity       Float
  type           String // IN, OUT
  description    String?
  createdAt      DateTime      @default(now())
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model Location {
  id             String        @id @default(uuid())
  organizationId String?       @db.Uuid
  name           String        @unique
  description    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
  stockEntries   ProductStock[]

  @@schema("public")
}

model ProductStock {
  id             String        @id @default(uuid())
  productId      String
  locationId     String
  organizationId String?       @db.Uuid
  quantity       Float         @default(0)
  minStock       Float?
  lastSyncAt     DateTime?
  product        Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  location       Location      @relation(fields: [locationId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model AuditLog {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId      String?
  organizationId String?       @db.Uuid
  action         String
  details        String?
  userName       String?
  createdAt      DateTime?     @default(now()) @db.Timestamptz(6)
  userId         String?       @db.Uuid
  Project        Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Profile        Profile?      @relation(fields: [userId], references: [id], onUpdate: NoAction)
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Client {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?       @db.Uuid
  name           String
  email          String?
  phone          String?
  address        String?
  taxId          String?
  contactName    String?
  createdAt      DateTime      @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  updatedAt      DateTime      @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
  status         ClientStatus  @default(PROSPECT)
  Contact        Contact[]
  Interaction    Interaction[]
  Project        Project[]
  opportunities  Opportunity[]
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Contact {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId  String   @db.Uuid
  name      String
  email     String?
  phone     String?
  role      String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @db.Timestamptz(6)
  Client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Interaction {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId       String          @db.Uuid
  projectId      String?
  organizationId String?         @db.Uuid
  type           InteractionType
  date           DateTime        @default(now()) @db.Timestamptz(6)
  notes          String
  createdAt      DateTime        @default(now()) @db.Timestamptz(6)
  Client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Project        Project?        @relation(fields: [projectId], references: [id], onUpdate: NoAction)
  organization   Organization?   @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Profile {
  id             String        @id(map: "profile_pkey") @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?       @db.Uuid
  name           String
  email          String        @unique(map: "profile_email_key")
  role           MembershipRole @default(MEMBER)
  avatarUrl      String?
  createdAt      DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime      @default(now()) @db.Timestamptz(6)
  receiveProductTips Boolean @default(true)
  AuditLog           AuditLog[]
  organization       Organization?        @relation(fields: [organizationId], references: [id])
  OrganizationMember OrganizationMember[]
  EmailEventLog      EmailEventLog[]
  NudgeDismissed     NudgeDismissed[]

  @@schema("public")
}

model Organization {
  id                 String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  rut                String?
  logoUrl            String?
  settings           Json?                @default("{}")
  createdAt          DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime             @default(now()) @db.Timestamptz(6)
  status             OrganizationStatus?  @default(ACTIVE)
  plan               OrganizationPlan?    @default(FREE)
  profiles           Profile[]
  projects           Project[]
  tasks              Task[]
  alerts             SentinelAlert[]
  stats              OrganizationStats?
  subscription       Subscription?
  Opportunity        Opportunity[]
  Client             Client[]
  Company            Company[]
  Invoice            Invoice[]
  Product            Product[]
  Interaction        Interaction[]
  AuditLog           AuditLog[]
  ProjectLog         ProjectLog[]
  QuoteItem          QuoteItem[]
  CostEntry          CostEntry[]
  SaleNote           SaleNote[]
  UserInvitation     UserInvitation[]
  OrganizationMember OrganizationMember[]
  mode               OrganizationMode     @default(SOLO)
  inventoryMovements InventoryMovement[]
  locations          Location[]
  ProductStock       ProductStock[]
  activationEvents   ActivationEvent[]
  EmailEventLog      EmailEventLog[]
  NudgeDismissed     NudgeDismissed[]
  ExperimentAssignment ExperimentAssignment[]
  paymentIssues      PaymentIssue[]
  cancelIntents      CancelIntent[]

  @@schema("public")
}

model StripeEvent {
  id        String   @id // This is the Stripe Event ID
  type      String
  processed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@schema("public")
}

model Subscription {
  id                     String             @id @default(uuid())
  organizationId         String             @unique @db.Uuid
  status                 SubscriptionStatus @default(TRIALING)
  planCode               String             @default("FREE")
  trialEndsAt            DateTime?
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  cancelAtPeriodEnd      Boolean            @default(false)
  seatLimit              Int                @default(1)
  provider               String? // e.g., 'stripe'
  providerCustomerId     String?
  providerSubscriptionId String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  organization           Organization       @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model OrganizationMember {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String           @db.Uuid
  userId         String           @db.Uuid
  role           MembershipRole   @default(MEMBER)
  status         MembershipStatus @default(ACTIVE)
  createdAt      DateTime         @default(now()) @db.Timestamptz(6)
  organization   Organization     @relation(fields: [organizationId], references: [id])
  profile        Profile          @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId])
  @@schema("public")
}

model UserInvitation {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String
  role            MembershipRole   @default(MEMBER)
  organizationId  String           @db.Uuid
  tokenHash       String           @unique
  expiresAt       DateTime         @db.Timestamptz(6)
  createdAt       DateTime         @default(now()) @db.Timestamptz(6)
  acceptedAt      DateTime?        @db.Timestamptz(6)
  revokedAt       DateTime?        @db.Timestamptz(6)
  sentAt          DateTime?        @db.Timestamptz(6)
  sentCount       Int              @default(1)
  status          InvitationStatus @default(PENDING)
  invitedByUserId String?          @db.Uuid // Corregido el nombre para consistencia con el contrato
  organization    Organization     @relation(fields: [organizationId], references: [id])

  @@index([organizationId, email, status])
  @@index([tokenHash])
  @@index([organizationId, createdAt])
  @@schema("public")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED

  @@schema("public")
}

enum OrganizationStatus {
  PENDING
  ACTIVE
  INACTIVE

  @@schema("public")
}

enum OrganizationPlan {
  FREE
  PRO
  ENTERPRISE
  INVENTORY_ONLY

  @@schema("public")
}

enum OrganizationMode {
  SOLO
  TEAM

  @@schema("public")
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAUSED
  PAST_DUE
  CANCELED

  @@schema("public")
}

enum MembershipStatus {
  PENDING
  ACTIVE
  INACTIVE
  REMOVED

  @@schema("public")
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER

  @@schema("public")
}

enum ProjectStatus {
  EN_CURSO
  EN_ESPERA
  BLOQUEADO
  CERRADO
  CANCELADO

  @@schema("public")
}

enum ProjectStage {
  LEVANTAMIENTO
  DISENO
  DESARROLLO
  QA             @map("QA")
  IMPLEMENTACION
  SOPORTE

  @@schema("public")
}

enum CostCategory {
  SERVICIOS
  HARDWARE
  SOFTWARE
  LOGISTICA
  OTROS

  @@schema("public")
}

enum ClientStatus {
  LEAD
  PROSPECT
  CLIENT
  CHURNED

  @@schema("public")
}

enum InteractionType {
  CALL
  EMAIL
  MEETING
  NOTE

  @@schema("public")
}

model Task {
  id             String        @id @default(uuid())
  projectId      String
  organizationId String?       @db.Uuid
  title          String
  description    String?
  status         TaskStatus    @default(PENDING)
  dueDate        DateTime?
  priority       Int           @default(0) // 0: Normal, 1: High
  type           TaskType      @default(MANUAL)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

enum TaskType {
  MANUAL
  SENTINEL

  @@schema("public")
}

enum TaskStatus {
  PENDING
  COMPLETED

  @@schema("public")
}

model Quote {
  id        String      @id @default(uuid())
  projectId String
  version   Int         @default(1)
  status    QuoteStatus @default(DRAFT)
  totalNet  Float       @default(0)
  totalTax  Float       @default(0)
  frozenAt  DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items     QuoteItem[]

  @@schema("public")
}

model Opportunity {
  id                  String        @id @default(uuid())
  title               String
  description         String?
  value               Float?
  probability         Int?          @default(0)
  stage               String        @default("QUALIFIED")
  expectedCloseDate   DateTime?
  lastInteractionDate DateTime?     @db.Timestamptz(6)
  nextInteractionDate DateTime?     @db.Timestamptz(6)
  clientId            String?       @db.Uuid
  organizationId      String?       @db.Uuid
  closeReason         CloseReason?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  client              Client?       @relation(fields: [clientId], references: [id])
  organization        Organization? @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model SentinelAlert {
  id             String           @id @default(uuid())
  organizationId String           @db.Uuid
  type           SentinelType
  severity       SentinelSeverity
  title          String
  message        String
  status         AlertStatus      @default(OPEN)
  metadata       Json? // Para guardar links al proyecto, stock id, etc.
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

model OrganizationStats {
  id               String       @id @default(uuid())
  organizationId   String       @unique @db.Uuid
  wau              Int          @default(0)
  mau              Int          @default(0)
  daysToFirstQuote Int?
  firstValueAt     DateTime?
  ttvDays          Float?
  crmCount         Int          @default(0)
  quotesCount      Int          @default(0)
  projectsCount    Int          @default(0)
  inventoryCount   Int          @default(0)
  lastActivityAt    DateTime     @default(now())
  lastSentinelRunAt DateTime?
  healthScore       Int          @default(100)
  attributes        Json?        @default("{}")
  organization      Organization @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

enum SentinelType {
  STOCK_CRITICAL
  BUDGET_OVERFLOW
  INVOICE_OVERDUE
  STALE_PROJECT
  LOW_MARGIN
  QUOTE_FOLLOWUP

  @@schema("public")
}

enum SentinelSeverity {
  S0
  S1
  S2
  S3

  @@schema("public")
}

enum AlertStatus {
  OPEN
  ACK
  RESOLVED

  @@schema("public")
}

enum CloseReason {
  PRICE
  COMPETITION
  DELAY
  SCOPE
  DISCARDED
  OTHER

  @@schema("public")
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REVISED
  REJECTED

  @@schema("public")
}

model ActivationEvent {
  id             String       @id @default(uuid())
  organizationId String       @db.Uuid
  userId         String?      @db.Uuid
  eventName      String
  occurredAt     DateTime     @default(now())
  entityId       String?
  metadata       Json?        @default("{}")
  dedupeKey      String?      @unique
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, eventName])
  @@schema("public")
}

model Experiment {
  id          String   @id @default(uuid())
  key         String   @unique
  variants    Json     // ["A", "B"]
  enabled     Boolean  @default(true)
  startAt     DateTime @default(now())
  endAt       DateTime?
  assignments ExperimentAssignment[]

  @@schema("public")
}

model ExperimentAssignment {
  id             String      @id @default(uuid())
  organizationId String      @db.Uuid
  experimentId   String
  variant        String
  assignedAt     DateTime    @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
  experiment     Experiment   @relation(fields: [experimentId], references: [id])

  @@unique([organizationId, experimentId])
  @@schema("public")
}

model EmailEventLog {
  id             String       @id @default(uuid())
  organizationId String       @db.Uuid
  userId         String       @db.Uuid
  templateKey    String
  dedupeKey      String       @unique
  sentAt         DateTime     @default(now())
  providerMessageId String?
  meta           Json?        @default("{}")
  organization   Organization @relation(fields: [organizationId], references: [id])
  profile        Profile      @relation(fields: [userId], references: [id])

  @@schema("public")
}

model NudgeDismissed {
  id             String       @id @default(uuid())
  organizationId String       @db.Uuid
  userId         String       @db.Uuid
  dedupeKey      String
  dismissedAt    DateTime     @default(now())
  expiresAt      DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id])
  profile        Profile      @relation(fields: [userId], references: [id])

  @@unique([userId, organizationId, dedupeKey])
  @@schema("public")
}

model PaymentIssue {
  id             String        @id @default(uuid())
  organizationId String        @db.Uuid
  status         PaymentIssueStatus @default(OPEN)
  lastAttemptAt  DateTime      @default(now())
  attemptCount   Int           @default(1)
  invoiceId      String?
  customerPortalUrl String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

enum PaymentIssueStatus {
  OPEN
  RESOLVED
  EXPIRED

  @@schema("public")
}

model CancelIntent {
  id             String        @id @default(uuid())
  organizationId String        @db.Uuid
  userId         String        @db.Uuid
  reason         CancellationReason
  comment        String?
  variant        String?       // For A/B testing: CONTINUITY, VALUE_ROI
  outcome        CancelOutcome @default(CANCEL_PENDING)
  createdAt      DateTime      @default(now())
  organization   Organization  @relation(fields: [organizationId], references: [id])

  @@schema("public")
}

enum CancellationReason {
  PRICE
  MISSING_FEATURE
  HARD_TO_USE
  NOT_USING_IT
  BUGS
  SWITCHING_COMPETITOR
  TEMPORARY_PROJECT
  SUPPORT_ISSUE
  OTHER

  @@schema("public")
}

enum CancelOutcome {
  CANCEL_PENDING
  SAVED_PAUSE
  SAVED_DOWNGRADE
  SAVED_DISCOUNT
  COMPLETED
  RECOVERED

  @@schema("public")
}
