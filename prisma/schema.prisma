generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Settings {
  id                      Int     @id @default(1)
  currency                String  @default("CLP")
  vatRate                 Float   @default(0.19)
  defaultPaymentTermsDays Int     @default(30)
  yellowThresholdDays     Int     @default(7)
}

model Company {
  id          String   @id @default(uuid())
  name        String
  taxId       String?  // RUT
  address     String?
  phone       String?
  email       String?
  contactName String?
  projects    Project[]
}

model Project {
  id             String        @id // PRJ-###
  companyId      String
  company        Company       @relation(fields: [companyId], references: [id])
  name           String
  responsible    String
  status         ProjectStatus
  stage          ProjectStage
  progress       Int           @default(0) // 0-100
  startDate      DateTime
  plannedEndDate DateTime
  nextAction     String?
  budgetNet      Float         @default(0)
  marginPct      Float         @default(0.30)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  costEntries CostEntry[]
  invoices    Invoice[]
  quoteItems  QuoteItem[]
  logs        ProjectLog[]
}

model QuoteItem {
  id        String @id @default(uuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sku       String?
  detail    String
  quantity  Float   @default(1)
  unit      String  @default("UN") // UN, GL, HR...
  priceNet  Float   @default(0)
  costNet   Float   @default(0)
}

model CostEntry {
  id          String       @id @default(uuid())
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  date        DateTime
  category    CostCategory
  description String
  amountNet   Float
}

model Invoice {
  id                  String    @id @default(uuid())
  projectId           String
  project             Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sent                Boolean   @default(false)
  sentDate            DateTime?
  paymentTermsDays    Int?
  dueDate             DateTime?
  amountInvoicedGross Float     @default(0)
  amountPaidGross     Float     @default(0)
  updatedAt           DateTime  @updatedAt
}

enum ProjectStatus {
  EN_CURSO   @map("En curso")
  EN_ESPERA  @map("En espera")
  BLOQUEADO  @map("Bloqueado")
  CERRADO    @map("Cerrado")
  CANCELADO  @map("Cancelado")
}

enum ProjectStage {
  LEVANTAMIENTO  @map("Levantamiento")
  DISENO         @map("Diseño")
  DESARROLLO     @map("Desarrollo")
  QA             @map("QA")
  IMPLEMENTACION @map("Implementación")
  SOPORTE        @map("Soporte")
}

enum CostCategory {
  SERVICIOS @map("Servicios")
  HARDWARE  @map("Hardware")
  SOFTWARE  @map("Software")
  LOGISTICA @map("Logística")
  OTROS     @map("Otros")
}

model ProjectLog {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  content   String
  type      String   @default("INFO") // INFO, BLOCKER, MILESTONE, STATUS_CHANGE
  createdAt DateTime @default(now())
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  name        String
  description String?
  unit        String   @default("UN")
  priceNet    Float    @default(0)
  costNet     Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
